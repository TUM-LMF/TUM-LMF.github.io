<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.88/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.88/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<script src="https://raw.githubusercontent.com/kaktus40/Cesium-GeoserverTerrainProvider/master/GeoserverTerrainProvider.js" type="text/javascript"></script>
</head>
<body>
	<div id="cesiumContainer" style="width:100%;height:100%;"></div>
	<div id="baseLayerPickerContainer" style="position:absolute;top:13px;left:13px;width:338px;height:512px;"></div>
  	<script>
  	// ### Predefinitions for Viewer ###
  	Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwNmQ2ZTQ5ZS0zMjZlLTQ2ZjMtOTMxYy02YjM3ZmQ2ZjgwMDIiLCJpZCI6ODE1OTUsImlhdCI6MTY0NDIxODI4OH0.qnvoYt8vjupU8UXaRGZeBq8OPa1Mqfb9cq-ETU1TxVI"
  	// ## Search Engine ##
	function OpenStreetMapNominatimGeocoder() {}
    OpenStreetMapNominatimGeocoder.prototype.geocode = function (input) {
  		var endpoint = "https://nominatim.openstreetmap.org/search";
  		var resource = new Cesium.Resource({
			url: endpoint,
			queryParameters: {
  				format: "json",
  				q: input,
			},
  		});

  		return resource.fetchJson().then(function (results) {
			var bboxDegrees;
			return results.map(function (resultObject) {
  				bboxDegrees = resultObject.boundingbox;
  				return {
				displayName: resultObject.display_name,
				destination: Cesium.Rectangle.fromDegrees(
  					bboxDegrees[2],
  					bboxDegrees[0],
  					bboxDegrees[3],
  					bboxDegrees[1]
				),
  				};
			});
  		});
	};
	
	// ## Clock ## 
	var start_string = "2016-01-01"
	var stop_string = new Date().toISOString()
	var isostring = [start_string,stop_string,"/P1D"].join("/")

	var start = Cesium.JulianDate.fromIso8601(start_string);
    var stop = Cesium.JulianDate.fromIso8601(stop_string);
    
    function dataCallback(interval, index) {
        var time;
        if (index === 0) {
        // leading
        time = Cesium.JulianDate.toIso8601(interval.stop);
        } else {
        time = Cesium.JulianDate.toIso8601(interval.start);
        }

        return {
            Time: time,
        };
    }

    var times = Cesium.TimeIntervalCollection.fromIso8601({
        // iso8601: start_string+"/"+stop_string+"/P1D",
        // iso8601: new start_string.concat("/",stop_string,"/P1D")
        iso8601: "2016-01-01/2022-12-31/P1D",
        leadingInterval: true,
        trailingInterval: true,
        isStopIncluded: true,
        dataCallback: dataCallback,
    });
		
	// ### DEFINE VIEWER ###
	// ## Basic Definition ##
    const viewer = new Cesium.Viewer('cesiumContainer', {	
      	terrainProvider: new Cesium.CesiumTerrainProvider({
                            url: Cesium.IonResource.fromAssetId(818620),
                         }),//Cesium.createWorldTerrain(),
		imageryProvider: false,
  		homeButton: true,
		fullscreenButton: true,
		CreditsDisplay: true,
		infoBox: false,
  		geocoder: new OpenStreetMapNominatimGeocoder(),
	  	sceneMode: Cesium.SceneMode.SCENE2D,
  		sceneModePicker: true,
  		navigationHelpButton: false,
	  	animation: true,
		timeline: true,
		baseLayerPicker: false,
		useBrowserRecommendedResolution: true,
	});
	viewer._cesiumWidget._creditContainer.parentNode.removeChild(
        viewer._cesiumWidget._creditContainer
	);
	viewer.scene.globe.baseColor = Cesium.Color.WHITE;

    // ## Terrain Exaggeration for better visibility ##
	viewer.scene.globe.terrainExaggeration = Math.sqrt(2);

    // ## Home Camera ##
	var extent = Cesium.Rectangle.fromDegrees(8.8,47.2,13.9,50.6);
	Cesium.Camera.DEFAULT_VIEW_RECTANGLE = extent;

	viewer.camera.setView({
  		destination: Cesium.Rectangle.fromDegrees(8.8,47.2,13.9,50.6),
  		orientation: {
    		heading: Cesium.Math.toRadians(175.0),
    		pitch: Cesium.Math.toRadians(-35.0),
    		roll: 0.0
  		}
    });

    // ## Start Clock ##
    viewer.clock.currentTime = stop;
    viewer.clock.multiplier = 28800;
    viewer.timeline.zoomTo(start, stop);
    
    // ## Entities ##
    var entity = viewer.entities.add({
        label: {
            show: false,
            showBackground: true,
            font: "12px sans-serif",// monospace",
            horizontalOrigin: Cesium.HorizontalOrigin.LEFT,
            verticalOrigin: Cesium.VerticalOrigin.TOP,
            pixelOffset: new Cesium.Cartesian2(15, 0),
        },
    });

    // ## Event Handlers ##
    // # Mouse over the globe to see the cartographic position next to mouse #
    handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(movement){
        var cartesian = viewer.camera.pickEllipsoid(
            movement.endPosition,
            viewer.scene.globe.ellipsoid
        );
        
        if (cartesian) {
            var cartographic = Cesium.Cartographic.fromCartesian(cartesian);
            var longitudeString = Cesium.Math.toDegrees(cartographic.longitude).toFixed(4);
            var latitudeString = Cesium.Math.toDegrees(cartographic.latitude).toFixed(4);
    
            entity.position = cartesian;
            entity.label.show = true;
            entity.label.text = longitudeString+","+latitudeString
        }
        else {
            entity.label.show = false;
        }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

    // # Return Coordinates (for copying to clipboard) #
    function getME_coordinates(e){
        var mousePosition = new Cesium.Cartesian2(e.clientX, e.clientY); // ### TODO: NOT MOUSPOSITION, IS POSITION OF LEFT UPPER CORNER SOMEHOW ###
        var cartesian = viewer.camera.pickEllipsoid(
            mousePosition,
            viewer.scene.globe.ellipsoid
        );
        
        if (cartesian) {
            var cartographic = Cesium.Cartographic.fromCartesian(cartesian);
            var longitudeString = Cesium.Math.toDegrees(cartographic.longitude);
            var latitudeString = Cesium.Math.toDegrees(cartographic.latitude);
            //var message = "LonLat: "+longitudeString+","+latitudeString+"\nLatLon: "+latitudeString+","+longitudeString;
            //alert(message);
            prompt("Copy LonLat to clipboard:",longitudeString+","+latitudeString);
        }
        else{
            alert("Zoom in to show coordinates!")
        }  
    };
    
    // # Key Event Handling #
    document.onkeydown = function(e){
        var keyCode = e.keyCode;
        if(keyCode == 17) {
            getME_coordinates(e);
        }
        else if(keyCode == 17){
            alert("Hallo!");
        }
    };
    
    //navigator.geolocation.getCurrentPosition(alert); # get position of user

	// ### DEFINE LAYERS ###
	// ## Baselayer ##
	WMTS_OpenTopoMap = new Cesium.OpenStreetMapImageryProvider({
		url : 'https://a.tile.opentopomap.org/',
		// url : "https://maps.bergfex.at/osm/standard/"
    });

	// ## Sentinel Hub based ##
	// # Sentinel 2 True Color #
    WMS_Sentinel2_TrueColor_maxcc100 = new Cesium.WebMapServiceImageryProvider({
    	url: "https://services.sentinel-hub.com/ogc/wms/425d8b48-c4a6-4e52-8f0b-f1ad26e8ae64",
    	parameters: {
 	 	 	maxcc:100,
 	 	 	format: "image/jpg",
 	 	 	preset:"TRUE_COLOR_VISUALIZATION", 
 	 	 	layers:"TRUE_COLOR_VISUALIZATION,DATE", 
 	 	 	priority:"mostRecent",
 	 	 	PREVIEW:2,
 	 	 	//time:"2021-05-10/None",
        },
		minimalLevel: 1,
		maximalLevel: 16,
		clock: viewer.clock,
        times: times,
		credit: new Cesium.Credit("Sentinel 2"),
    });
    
    WMS_Sentinel2_TrueColor_maxcc20 = new Cesium.WebMapServiceImageryProvider({
    	url: "https://services.sentinel-hub.com/ogc/wms/425d8b48-c4a6-4e52-8f0b-f1ad26e8ae64",
    	parameters: {
 	 	 	maxcc:20,
 	 	 	format: "image/jpg",
 	 	 	preset:"TRUE_COLOR_VISUALIZATION", 
 	 	 	layers:"TRUE_COLOR_VISUALIZATION,DATE", 
 	 	 	priority:"mostRecent",
 	 	 	PREVIEW:2,
 	 	 	//time:"2021-05-10/None",
        },
		minimalLevel: 1,
		maximalLevel: 16,
		clock: viewer.clock,
        times: times,
		credit: new Cesium.Credit("Sentinel 2"),
    });
    
    // # Sentinel 2 True Color L2A #
    WMS_Sentinel2_TrueColorL2A_maxcc100 = new Cesium.WebMapServiceImageryProvider({
    	url: "https://services.sentinel-hub.com/ogc/wms/425d8b48-c4a6-4e52-8f0b-f1ad26e8ae64",
    	parameters: {
 	 	 	maxcc:100,
 	 	 	format: "image/jpg",
 	 	 	preset:"TRUE_COLOR_VISUALIZATION_L2A", 
 	 	 	layers:"TRUE_COLOR_VISUALIZATION_L2A,DATE", 
 	 	 	priority:"mostRecent",
 	 	 	PREVIEW:2,
 	 	 	//time:"2021-05-10/None",
        },
		minimalLevel: 1,
		maximalLevel: 16,
		clock: viewer.clock,
        times: times,
		credit: new Cesium.Credit("Sentinel 2"),
    });
    
    WMS_Sentinel2_TrueColorL2A_maxcc20 = new Cesium.WebMapServiceImageryProvider({
    	url: "https://services.sentinel-hub.com/ogc/wms/425d8b48-c4a6-4e52-8f0b-f1ad26e8ae64",
    	parameters: {
 	 	 	maxcc:20,
 	 	 	format: "image/jpg",
 	 	 	preset:"TRUE_COLOR_VISUALIZATION_L2A", 
 	 	 	layers:"TRUE_COLOR_VISUALIZATION_L2A,DATE", 
 	 	 	priority:"mostRecent",
 	 	 	PREVIEW:2,
 	 	 	//time:"2021-05-10/None",
        },
		minimalLevel: 1,
		maximalLevel: 16,
		clock: viewer.clock,
        times: times,
		credit: new Cesium.Credit("Sentinel 2"),
    });
    // # Sentinel 2 SNOWME #
    WMS_Sentinel2_SNOWME_maxcc100 = new Cesium.WebMapServiceImageryProvider({
    	url: "https://services.sentinel-hub.com/ogc/wms/425d8b48-c4a6-4e52-8f0b-f1ad26e8ae64",
    	parameters: {
 	 	 	maxcc:100,
			format: "image/png",
 	 	 	preset:"SNOWME", 
 	 	 	layers:"SNOWME,DATE",
 	 	 	priority:"mostRecent",
 	 	 	PREVIEW:2,
 	 	 	//time:"2021-05-10/None",
        },
		//minimalLevel: 1,
		//maximalLevel: 16,
		clock: viewer.clock,
        times: times,
		credit: new Cesium.Credit("Sentinel 2 SNOWME"),
    });
    
    WMS_Sentinel2_SNOWME_maxcc20 = new Cesium.WebMapServiceImageryProvider({
    	url: "https://services.sentinel-hub.com/ogc/wms/425d8b48-c4a6-4e52-8f0b-f1ad26e8ae64",
    	parameters: {
 	 	 	maxcc:20,
			format: "image/png",
 	 	 	preset:"SNOWME", 
 	 	 	layers:"SNOWME,DATE",
 	 	 	priority:"mostRecent",
 	 	 	PREVIEW:2,
 	 	 	//time:"2021-05-10/None",
        },
		//minimalLevel: 1,
		//maximalLevel: 16,
		clock: viewer.clock,
        times: times,
		credit: new Cesium.Credit("Sentinel 2 SNOWME"),
    });
	// ## NASA ##
	WMS_VIIRS_TrueColor_Day = new Cesium.WebMapServiceImageryProvider({
        url: "https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi?SERVICE=WMS",
        parameters: {
    		format: "image/png",
 	 	 	layers: "VIIRS_SNPP_CorrectedReflectance_TrueColor",
        },
        clock: viewer.clock,
        times: times,
		minimalLevel: 1,
		maximalLevel: 16,
		credit: new Cesium.Credit("NASA"),
    });
    
    WMS_VIIRS_TrueColor_Night = new Cesium.WebMapServiceImageryProvider({
        url: "https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi?SERVICE=WMS",
        parameters: {
    		format: "image/png",
 	 	 	layers: "VIIRS_SNPP_DayNightBand_ENCC",
        },
        clock: viewer.clock,
        times: times,
		minimalLevel: 1,
		maximalLevel: 16,
		credit: new Cesium.Credit("NASA"),
    });
	// ## LDBV ##
	WMS_LDBV_LABEL = new Cesium.WebMapServiceImageryProvider({
        url: "https://services.sentinel-hub.com/ogc/wms/a01a97a3-1507-4578-b2f4-8a512f82a089?",
        parameters: {
    		format: "image/jpg",
 	 	 	layers: "LDBV_LABEL_VISUALIZATION",
        },
        clock: viewer.clock,
        times: times,
		minimalLevel: 1,
		maximalLevel: 16,
		credit: new Cesium.Credit("LDBV"),
    });


	// ## Standard layer
	viewer.imageryLayers.addImageryProvider(WMTS_OpenTopoMap);

	// ### DEFINE BASELAYER ###

	// ### DEFINE OVERLAYS ###
	var imageryViewModels = [];
	imageryViewModels.push(new Cesium.ProviderViewModel({
 		name : 'Open\u00adTopo\u00adMap',
 		iconUrl : Cesium.buildModuleUrl('Widgets/Images/ImageryProviders/openStreetMap.png'),
 		tooltip : 'OpenTopoMap (OTM) is a collaborative project to create a free editable map of the world.\nhttp://www.opentopomap.org',
 		creationFunction : function() {
     		return WMTS_OpenTopoMap 
 		}
 	}));
 	imageryViewModels.push(new Cesium.ProviderViewModel({
 		name : "Sentinel 2 True Color",
 		iconUrl : "https://scontent-muc2-1.xx.fbcdn.net/v/t1.6435-9/151732866_3679818422072193_1062297694204991631_n.png?_nc_cat=101&ccb=1-5&_nc_sid=09cbfe&_nc_ohc=47UrChUb5VcAX8NVLu7&_nc_ht=scontent-muc2-1.xx&oh=00_AT-iQsImca7L871ZcCtK7qe-OTSfsR7PgGzXPv3c9TIWEQ&oe=620BD9BE",
 		tooltip : "Most recent True Color Sentinel 2 image",
 		creationFunction : function() {
     		return WMS_Sentinel2_TrueColor_maxcc100
 		}
 	}));
 	imageryViewModels.push(new Cesium.ProviderViewModel({
 		name : "Sentinel 2 True Color maxcc20",
 		iconUrl : "https://scontent-muc2-1.xx.fbcdn.net/v/t1.6435-9/151732866_3679818422072193_1062297694204991631_n.png?_nc_cat=101&ccb=1-5&_nc_sid=09cbfe&_nc_ohc=47UrChUb5VcAX8NVLu7&_nc_ht=scontent-muc2-1.xx&oh=00_AT-iQsImca7L871ZcCtK7qe-OTSfsR7PgGzXPv3c9TIWEQ&oe=620BD9BE",
 		tooltip : "Most recent True Color Sentinel 2 image with maximum 20% cloud coverage",
 		creationFunction : function() {
     		return WMS_Sentinel2_TrueColor_maxcc20
 		}
 	}));
 	 imageryViewModels.push(new Cesium.ProviderViewModel({
 		name : "Sentinel 2 True Color L2A",
 		iconUrl : "https://scontent-muc2-1.xx.fbcdn.net/v/t1.6435-9/151732866_3679818422072193_1062297694204991631_n.png?_nc_cat=101&ccb=1-5&_nc_sid=09cbfe&_nc_ohc=47UrChUb5VcAX8NVLu7&_nc_ht=scontent-muc2-1.xx&oh=00_AT-iQsImca7L871ZcCtK7qe-OTSfsR7PgGzXPv3c9TIWEQ&oe=620BD9BE",
 		tooltip : "Most recent True Color Sentinel 2 image",
 		creationFunction : function() {
     		return WMS_Sentinel2_TrueColorL2A_maxcc100
 		}
 	}));
 	imageryViewModels.push(new Cesium.ProviderViewModel({
 		name : "Sentinel 2 True Color L2A maxcc20",
 		iconUrl : "https://scontent-muc2-1.xx.fbcdn.net/v/t1.6435-9/151732866_3679818422072193_1062297694204991631_n.png?_nc_cat=101&ccb=1-5&_nc_sid=09cbfe&_nc_ohc=47UrChUb5VcAX8NVLu7&_nc_ht=scontent-muc2-1.xx&oh=00_AT-iQsImca7L871ZcCtK7qe-OTSfsR7PgGzXPv3c9TIWEQ&oe=620BD9BE",
 		tooltip : "Most recent True Color Sentinel 2 image with maximum 20% cloud coverage",
 		creationFunction : function() {
     		return WMS_Sentinel2_TrueColorL2A_maxcc20
 		}
 	}));
 	imageryViewModels.push(new Cesium.ProviderViewModel({
 		name : "Sentinel 2 SnowME",
 		iconUrl : "https://scontent-muc2-1.xx.fbcdn.net/v/t1.6435-9/151732866_3679818422072193_1062297694204991631_n.png?_nc_cat=101&ccb=1-5&_nc_sid=09cbfe&_nc_ohc=47UrChUb5VcAX8NVLu7&_nc_ht=scontent-muc2-1.xx&oh=00_AT-iQsImca7L871ZcCtK7qe-OTSfsR7PgGzXPv3c9TIWEQ&oe=620BD9BE",
 		tooltip : "Most recent SNOWME image",
 		creationFunction : function() {
     		return WMS_Sentinel2_SNOWME_maxcc100
 		}
 	}));
 	imageryViewModels.push(new Cesium.ProviderViewModel({
 		name : "Sentinel 2 SnowME maxcc20",
 		iconUrl : "https://scontent-muc2-1.xx.fbcdn.net/v/t1.6435-9/151732866_3679818422072193_1062297694204991631_n.png?_nc_cat=101&ccb=1-5&_nc_sid=09cbfe&_nc_ohc=47UrChUb5VcAX8NVLu7&_nc_ht=scontent-muc2-1.xx&oh=00_AT-iQsImca7L871ZcCtK7qe-OTSfsR7PgGzXPv3c9TIWEQ&oe=620BD9BE",
 		tooltip : "SNOWME image with maximum 20% cloud coverage",
 		creationFunction : function() {
     		return WMS_Sentinel2_SNOWME_maxcc20
 		}
 	}));
	imageryViewModels.push(new Cesium.ProviderViewModel({
 		name : "NASA Day",
 		iconUrl : "https://www.nasa.gov/sites/all/themes/custom/nasatwo/images/nasa-logo.svg",
 		tooltip : "Most recent True Color image from VIIRS satellite mission",
 		creationFunction : function() {
     		return WMS_VIIRS_TrueColor_Day
 		}
 	}));
 	imageryViewModels.push(new Cesium.ProviderViewModel({
 		name : "NASA Night",
 		iconUrl : "https://www.nasa.gov/sites/all/themes/custom/nasatwo/images/nasa-logo.svg",
 		tooltip : "Most recent True Color image from VIIRS satellite mission",
 		creationFunction : function() {
     		return WMS_VIIRS_TrueColor_Night
 		}
 	}));
	imageryViewModels.push(new Cesium.ProviderViewModel({
 		name : "LDBV Label",
 		iconUrl : "https://www.ldbv.bayern.de/images/customer/grosses_staatswappen.svg",
 		tooltip : "Label from the Bavarian Bureau of Geodesy",
 		creationFunction : function() {
     		return WMS_LDBV_LABEL
 		}
 	}));

	var baseLayerPicker = new Cesium.BaseLayerPicker('baseLayerPickerContainer', {
    	globe : viewer.cesiumWidget.scene.globe,
    	imageryProviderViewModels : imageryViewModels,
	});
	
  </script>
 </div>
</body>
</html>
